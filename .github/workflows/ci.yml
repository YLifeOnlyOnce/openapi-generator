name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Validate OpenAPI spec
      run: |
        npx @apidevtools/swagger-parser validate spec/example-api.yaml
        
    - name: Generate API client and docs
      run: |
        # 设置临时版本号
        export npm_package_version="0.0.0-dev"
        
        # 运行生成脚本
        ./scripts/generate.sh
        
        # 运行后处理脚本
        ./scripts/post-generate.sh
        
    - name: Verify generated files
      run: |
        # 检查生成的文件是否存在
        test -f generated/client/package.json || (echo "Client package.json not found" && exit 1)
        test -f generated/client/index.ts || (echo "Client index.ts not found" && exit 1)
        test -f generated/docs/index.html || (echo "Documentation index.html not found" && exit 1)
        
        echo "✅ All generated files are present"
        
    - name: Build client
      run: |
        cd generated/client
        npm install
        npm run build
        
        # 检查构建输出
        test -f dist/index.js || (echo "Built index.js not found" && exit 1)
        test -f dist/index.d.ts || (echo "Built index.d.ts not found" && exit 1)
        
        echo "✅ Client built successfully"
        
    - name: Upload artifacts for review
      uses: actions/upload-artifact@v3
      with:
        name: generated-files-${{ github.sha }}
        path: |
          generated/client/
          generated/docs/
        retention-days: 7